
# The script will get estimated Defender for Cloud Malware Scanning Costs for supported V2 Storage Accounts with blob containers across all subscriptions in a tenant based on the ingress metric, which is in bytes. 
# - Malware Scanning currently only scans blobs less than 2GB, the ingress metric does not differentiate this.
# - The ingress metric used in this script is based on the last 30 days at a 5 minute interval
# - Overall this estimate is a ballpark and not to be expected as 100% accurate 

$requiredModules = 'Az.Accounts', 'Az.Storage', 'Az.Monitor'
$availableModules = Get-Module -ListAvailable -Name $requiredModules
$modulesToInstall = $requiredModules | where-object {$_ -notin $availableModules.Name}
ForEach ($module in $modulesToInstall){
    Write-Host "Installing Missing PowerShell Module: $module" -ForegroundColor Yellow
    Install-Module $module -force
}

#Load Latest Version 
ForEach ($module in $requiredModules){
    Remove-Module $module -Force -Confirm:$false -ErrorAction SilentlyContinue
    (Get-Module -Name $module -ListAvailable | Sort-Object -Property Version)[-1] | Import-Module
}

If(!(Get-AzContext)){
    Write-Host 'Connecting to Azure Subscription' -ForegroundColor Yellow
    Connect-AzAccount -WarningAction SilentlyContinue | Out-Null
}

If(!($Subscription)){
    $Subscription = Get-AzSubscription -WarningAction SilentlyContinue
}

# Get All Subscriptions
$subscriptions = Get-AzSubscription -WarningAction SilentlyContinue
$report = @()
ForEach ($subscription in $subscriptions){
    Set-AzContext -Subscription $subscription.Id | Out-Null
    Write-Host ('Getting All Storage Accounts in the {0} Subscription' -f $subscription.Name) -ForegroundColor Yellow

    $storageAccounts = Get-AzStorageAccount | Where Kind -like 'StorageV2' 
    Write-Host ('Found a Total of {0} storage accounts, getting ingress data volume in MB...' -f $storageAccounts.Count) -ForegroundColor Yellow

    ForEach ($storageAccount in $storageAccounts){
        $totalBlobIngress30dayBytes = $null
        $totalBlobIngress30dayMB = $null
        $totalBlobIngress30dayGB = $null
        $estimatedMalwareScanningCosts = $null
        $blobIngress = $null
        $totalBlobIngress = 0

        # Get blob ingress in bytes over the past 30 days per 5 minutes
        $blobIngress = Get-AzMetric -ResourceId $($storageAccount.id + "/blobservices/default") -MetricName Ingress -AggregationType Total -StartTime $((Get-Date).AddMonths(-1)) -EndTime $(Get-Date) -TimeGrain 00:05:00 -WarningAction SilentlyContinue

        # Get Total ingress bytes over the past 30 days
        $blobIngress.Data.Total | % {$totalBlobIngress += $_}
    
        $totalBlobIngress30dayBytes = $totalBlobIngress
        $totalBlobIngress30dayMB = [math]::round([decimal]$totalBlobIngress/1000/1000,6)
        $totalBlobIngress30dayGB = [math]::round([decimal]$totalBlobIngress/1000/1000/1000,6)
        $estimatedMalwareScanningCosts = [math]::round([decimal]$totalBlobIngress30dayGB * 0.15,6)

        Write-Host ('    {0} totalBlobIngress30dayBytes: {1}, totalBlobIngress30dayMB:{2} totalBlobIngress30dayGB: {3}, estimatedMalwareScanningCosts: {4}' -f $storageAccount.StorageAccountName,  $totalBlobIngress30dayBytes, $totalBlobIngress30dayMB, $totalBlobIngress30dayGB, $estimatedMalwareScanningCosts) -ForegroundColor Yellow

        $storageAccount | Add-Member -MemberType NoteProperty -Name 'Subscription' -Value $subscription.Name -Force -ErrorAction SilentlyContinue
        $storageAccount | Add-Member -MemberType NoteProperty -Name 'totalBlobIngress30dayBytes' -Value $totalBlobIngress30dayBytes -Force -ErrorAction SilentlyContinue
        $storageAccount | Add-Member -MemberType NoteProperty -Name 'totalBlobIngress30dayMB' -Value $totalBlobIngress30dayMB -Force -ErrorAction SilentlyContinue
        $storageAccount | Add-Member -MemberType NoteProperty -Name 'totalBlobIngress30dayGB' -Value $totalBlobIngress30dayGB -Force -ErrorAction SilentlyContinue
        $storageAccount | Add-Member -MemberType NoteProperty -Name 'estimatedMalwareScanningCosts_$' -Value $estimatedMalwareScanningCosts -Force -ErrorAction SilentlyContinue
    }

    $report += $storageAccounts | Select StorageAccountName, Subscription, ResourceGroupName, totalBlobIngress30dayBytes, totalBlobIngress30dayMB, totalBlobIngress30dayGB, estimatedMalwareScanningCosts_$
}

$report | Export-CSV -Path .\malwareScanningEstimates.csv -Force

Write-Host ('CSV file created with estimates: {0}\{1}' -f $(pwd).path, 'malwareScanningEstimates.csv') -ForegroundColor Yellow
